
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Illarion Lua Reference</title>

    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sa, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <link href="stylesheets/screen-c9d8fa83.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-953e3353.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-e033bdd3.js"></script>

    <script>
      $(function() { setupCodeCopy(); });
    </script>
  </head>

  <body class="index" data-languages="[&quot;lua&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-e4cb266f.png" class="logo" alt="" />
        <div class="lang-selector">
              <a href="#" data-language-name="lua">Lua</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#tutorial" class="toc-h1 toc-link" data-title="Tutorial">Tutorial</a>
          </li>
          <li>
            <a href="#entry-points" class="toc-h1 toc-link" data-title="Entry Points">Entry Points</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#items" class="toc-h2 toc-link" data-title="Items">Items</a>
                  </li>
                  <li>
                    <a href="#npcs" class="toc-h2 toc-link" data-title="NPCs">NPCs</a>
                  </li>
                  <li>
                    <a href="#magic" class="toc-h2 toc-link" data-title="Magic">Magic</a>
                  </li>
                  <li>
                    <a href="#monsters" class="toc-h2 toc-link" data-title="Monsters">Monsters</a>
                  </li>
                  <li>
                    <a href="#fields" class="toc-h2 toc-link" data-title="Fields">Fields</a>
                  </li>
                  <li>
                    <a href="#quests" class="toc-h2 toc-link" data-title="Quests">Quests</a>
                  </li>
                  <li>
                    <a href="#scheduled" class="toc-h2 toc-link" data-title="Scheduled">Scheduled</a>
                  </li>
                  <li>
                    <a href="#server" class="toc-h2 toc-link" data-title="Server">Server</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#classes" class="toc-h1 toc-link" data-title="Classes">Classes</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#position" class="toc-h2 toc-link" data-title="position">position</a>
                  </li>
                  <li>
                    <a href="#colour" class="toc-h2 toc-link" data-title="colour">colour</a>
                  </li>
                  <li>
                    <a href="#character" class="toc-h2 toc-link" data-title="Character">Character</a>
                  </li>
                  <li>
                    <a href="#dialogs" class="toc-h2 toc-link" data-title="Dialogs">Dialogs</a>
                  </li>
                  <li>
                    <a href="#itemlookat" class="toc-h2 toc-link" data-title="ItemLookAt">ItemLookAt</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#common-bugs" class="toc-h1 toc-link" data-title="Common Bugs">Common Bugs</a>
          </li>
          <li>
            <a href="#changelog" class="toc-h1 toc-link" data-title="Changelog">Changelog</a>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a target="_blank" rel="noopener noreferrer" href='https://github.com/Illarion-eV/Illarion-Dev'>Local Illarion Development Server</a></li>
            <li><a target="_blank" rel="noopener noreferrer" href='https://github.com/vilarion/Illarion-Coding-Style'>Illarion Coding Style</a></li>
            <li><a target="_blank" rel="noopener noreferrer" href='https://github.com/Illarion-eV/Illarion-Lua/tree/main/source'>Documentation Sources</a></li>
            <li><a target="_blank" rel="noopener noreferrer" href='https://github.com/slatedocs/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <aside class="warning">                                                                                                  
This documentation is still in development, but will eventually replace the current version. See changelog for details.
</aside>
<h1 id='introduction'>Introduction</h1>
<p>Illarion game content like items, NPCs, quests, etc. is defined in scripts written in
<a target="_blank" rel="noopener noreferrer" href='https://www.lua.org/manual/5.2/'>Lua 5.2</a>
with Illarion specific extensions. This document describes these extensions. Those scripts can be found in the
<a target="_blank" rel="noopener noreferrer" href='https://github.com/Illarion-eV/Illarion-Content'>
official repository</a>, which has two branches. The <code>master</code> branch reflects the scripts used by the live game, while
the <code>develop</code> branch is used to prepare the next release. You can fork that repository on GitHub and clone it to your
hard drive for development or testing using the
<a target="_blank" rel="noopener noreferrer" href='https://github.com/Illarion-eV/Illarion-Dev'>
local development server</a>.</p>

<p>The recommended editor for Illarion scripting is
<a target="_blank" rel="noopener noreferrer" href='https://code.visualstudio.com/'>
Visual Studio Code</a>, which is available for Linux, Windows and macOS. You can use the extension <code>rog2.luacheck</code> to
automatically perform some code checks ahead of pull requests. If you are using Visual Studio Code and open the
repository directory as a folder, the required ISO 8859-1 encoding will be used automatically. A more detailed
description of setting up and using a development environment is available in the <a href="#tutorial">tutorial</a>.</p>

<aside class="notice">
Scripts need to be encoded in ISO 8859-1.
</aside>

<blockquote>
<p><code>item/apple.lua</code></p>
</blockquote>
<div class="highlight"><pre class="highlight lua tab-lua"><code><span class="c1">-- mandatory license header omitted for the sake of brevity</span>

<span class="kd">local</span> <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nc">M</span><span class="p">.</span><span class="nf">UseItem</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="c1">-- code handling items being used</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">M</span><span class="p">.</span><span class="nf">LookAtItem</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="c1">-- code handling items being looked at</span>
<span class="k">end</span>

<span class="c1">-- more entry points can follow</span>

<span class="k">return</span> <span class="n">M</span>
</code></pre></div>
<p>Every time a certain event happens (e.g someone using an item, a monster dying, someone logging into the game, etc.) a
script function is called. The name of that script is usually defined in the database, except for <em>server
scripts</em> which have a fixed name and implement very specific server behaviour not tied to a particular game object.</p>

<aside class="notice">
Scripts are defined inside the database using the following format:
<ul>
<li>Paths are relative to the repository base directory.</li>
<li>Directory/file names are seperated by a full stop (<code>.</code>).</li>
<li>The <code>.lua</code> extension is omitted.</li>
</ul>
E.g. a script <code>item/apple.lua</code> would be entered as <code>item.apple</code>.
</aside>

<p>The executed function is called an <a href="#entry-points"><em>entry point</em></a>, since it is run directly by the server. Scripts
defined in the database, as well as server scripts, return a table containing expected entry points.
A script does not need to include <em>all</em> possible entry points. For example, if an item has no <code>UseItem</code> entry point,
nothing happens when a player uses the item.</p>

<aside class="notice">
The available set of entry points describes all game behaviour scripts can handle.
</aside>
<h1 id='tutorial'>Tutorial</h1><h1 id='entry-points'>Entry Points</h1>
<p>As described in the <a href="#introduction">introduction</a>, entry points are the interface between server and scripts. The server
calls entry points on a variety of events to perform the implemented game mechanics. This allows the server to remain
unchanged and running, while scripts are updated at run-time.</p>

<p>Entry points are expected to be functions with pre-defined names, which the server will call. For the server to be able
to find the script these functions are in, the script is named in the db entry of the appropriate game entity. The only
exception are server scripts, which just have one exact name.</p>

<p>The server expects scripts to return a table, which contains all implemented entry points. In the following definitions
only the function signature is given for clarity.</p>

<p>Those scripts which are entered into the database, need to be named in the following format:</p>

<ul>
<li>Paths are relative to the repository base directory.</li>
<li>Directory/file names are seperated by a full stop (<code>.</code>).</li>
<li>The <code>.lua</code> extension is omitted.</li>
</ul>

<p>E.g. a script <code>item/apple.lua</code> would be entered as <code>item.apple</code>.</p>
<h2 id='items'>Items</h2>
<p><strong>Database field:</strong> <code>items.itm_script</code></p>
<h3 id='function-useitem-character-character-item-item-number-actionstate'><code>function UseItem(Character character, Item item, number actionState)</code></h3>
<p>A <code>character</code> uses an <code>item</code>.</p>
<h3 id='function-itemlookat-lookatitem-character-character-item-item'><code>function ItemLookAt LookAtItem(Character character, Item item)</code></h3>
<p>A <code>character</code> looks at an <code>item</code>. Needs to return an <a href="#itemlookat">ItemLookAt</a>.</p>
<h3 id='function-moveitembeforemove-character-user-item-source-item-target'><code>function MoveItemBeforeMove(Character user, Item source, Item target)</code></h3><h3 id='function-moveitemaftermove-character-user-item-source-item-target'><code>function MoveItemAfterMove(Character user, Item source, Item target)</code></h3><h3 id='function-nextcycle'><code>function NextCycle()</code></h3><h3 id='function-characteronfield-character-user'><code>function CharacterOnField(Character user)</code></h3><h2 id='npcs'>NPCs</h2><h2 id='magic'>Magic</h2><h2 id='monsters'>Monsters</h2><h2 id='fields'>Fields</h2><h2 id='quests'>Quests</h2><h2 id='scheduled'>Scheduled</h2><h2 id='server'>Server</h2><h3 id='combat'>Combat</h3><h3 id='death'>Death</h3><h3 id='depot'>Depot</h3><h3 id='item-inspection'>Item Inspection</h3><h3 id='learning'>Learning</h3><h3 id='login'>Login</h3><h3 id='logout'>Logout</h3><h3 id='player-inspection'>Player Inspection</h3><h3 id='reloading-scripts'>Reloading Scripts</h3><h1 id='classes'>Classes</h1><h2 id='position'>position</h2>
<p>Positions represent a location on the world map.</p>
<h3 id='variables'>Variables</h3>
<table><thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Writable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>x</td>
<td>number</td>
<td>yes</td>
<td>x coordinate, increases from west to east (lower left to upper right)</td>
</tr>
<tr>
<td>y</td>
<td>number</td>
<td>yes</td>
<td>y coordinate, increases from north to south (upper left to lower right)</td>
</tr>
<tr>
<td>z</td>
<td>number</td>
<td>yes</td>
<td>z coordinate, increases as levels go up</td>
</tr>
</tbody></table>
<h3 id='functions'>Functions</h3><h4 id='position-number-x-number-y-number-z'><code>position(number x, number y, number z)</code></h4><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">position</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>Returns position for map location (x, y, z).</p>
<h4 id='position-p1-position-p2'><code>position p1 == position p2</code></h4><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">equal</span> <span class="o">=</span> <span class="n">position</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">position</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">-- equal == true</span>
</code></pre></div>
<p>Compares two positions <code>p1</code> and <code>p2</code>. Returns</p>

<ul>
<li><code>true</code> if <code>p1.x == p2.x and p1.y == p2.y and p1.z == p2.z</code></li>
<li><code>false</code> otherwise</li>
</ul>
<h3 id='free-functions'>Free Functions</h3><h4 id='tostring-position-p'><code>tostring(position p)</code></h4><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">text</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">position</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">-- text == "(3, 4, 0)"</span>
</code></pre></div>
<p>Returns <code>&quot;(&quot; .. p.x .. &quot;, &quot; .. p.y .. &quot;, &quot; .. p.z .. &quot;)&quot;</code>.</p>

<aside class="warning">
A position obtained from a character is still linked to that character and will change when the character moves.
</aside>
<div class="highlight"><pre class="highlight lua tab-lua"><code><span class="n">user</span><span class="p">:</span><span class="n">forceWarp</span><span class="p">(</span><span class="n">position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">pos</span>              <span class="c1">-- pos is (0, 0, 0)</span>
<span class="n">user</span><span class="p">:</span><span class="n">forceWarp</span><span class="p">(</span><span class="n">position</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">-- now user.pos AND pos are (1, 1, 0)</span>
</code></pre></div>
<blockquote>
<p>Avoid this by creating a new position from individual coordinates.</p>
</blockquote>
<div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">position</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
</code></pre></div><h2 id='colour'>colour</h2>
<p>Colours are used to represent a characters skin or hair colour.</p>
<h3 id='variables'>Variables</h3>
<table><thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Writable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>red</td>
<td>number</td>
<td>yes</td>
<td>From 0 (no red) to 255 (full red)</td>
</tr>
<tr>
<td>green</td>
<td>number</td>
<td>yes</td>
<td>From 0 (no green) to 255 (full green)</td>
</tr>
<tr>
<td>blue</td>
<td>number</td>
<td>yes</td>
<td>From 0 (no blue) to 255 (full blue)</td>
</tr>
<tr>
<td>alpha</td>
<td>number</td>
<td>yes</td>
<td>From 0 (transparent) to 255 (opaque)</td>
</tr>
</tbody></table>
<h3 id='functions'>Functions</h3><h4 id='colour-number-red-number-green-number-blue-number-alpha-255'><code>colour(number red, number green, number blue [, number alpha = 255])</code></h4><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">black</span> <span class="o">=</span> <span class="n">colour</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>Creates colour for given RGBA values.</p>
<h2 id='character'>Character</h2>
<p>Players, NPCs and monsters are the three types of characters in Illarion.</p>

<p><img src="images/directions-a05aa5a6.png" alt="directions" /></p>
<h3 id='variables'>Variables</h3>
<table><thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Writable</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>number</td>
<td>no</td>
<td>character id</td>
</tr>
<tr>
<td>name</td>
<td>text</td>
<td>no</td>
<td>character name</td>
</tr>
<tr>
<td>pos</td>
<td>position</td>
<td>no</td>
<td>character position on world map</td>
</tr>
<tr>
<td>lastSpokenText</td>
<td>text</td>
<td>no</td>
<td>character&#39;s last spoken line of text</td>
</tr>
<tr>
<td>attackmode</td>
<td>boolean</td>
<td>no</td>
<td><code>true</code> if character currently attacks, <code>false</code> otherwise</td>
</tr>
<tr>
<td>activeLanguage</td>
<td>number</td>
<td>yes</td>
<td>0: common, 1: human, 2: dwarf, 3: elf, 4: lizard, 5: orc, 6: halfling, 7: fairy, 8: gnome, 9: goblin, 10: ancient</td>
</tr>
<tr>
<td>movepoints</td>
<td>number</td>
<td>yes</td>
<td>A character has a maximum of 21 movepoints. Every action like talking, fighting, using etc. needs at least 7 movepoints. The reduction of movepoints depends on the character&#39;s agility. A character gains one movepoint per decisecond.</td>
</tr>
</tbody></table>
<h3 id='text-speech-functions'>Text/Speech Functions</h3><h4 id='talk-number-mode-text-message'><code>talk(number mode, text message)</code></h4><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="n">user</span><span class="p">:</span><span class="n">talk</span><span class="p">(</span><span class="n">Character</span><span class="p">.</span><span class="n">say</span><span class="p">,</span> <span class="s2">"Hello World!"</span><span class="p">)</span>
</code></pre></div>
<p>Lets a character say/whisper/yell a <code>message</code>. <code>mode</code> can be <code>Character.say</code>, <code>Character.whisper</code> or <code>Character.yell</code>.</p>
<h2 id='dialogs'>Dialogs</h2>
<p>Dialogs are a more sophisticated approach to aquire user input than e.g. <code>user.lastSpokenText</code>. Each dialog serves a
specific purpose like displaying bulk text, interfacing with a merchant or with the crafting system. Dialogs should be
the preferred method for handling user input. If necessary new types should be implemented rather than abusing old
variants or falling back to <code>lastSpokenText</code>. Please note, that as with many functions dialogs work with all types of
characters (players, monsters, npcs) but only make sense with players. Using the other two types will work but do
nothing at all. Using a dialog always consists of three descrete steps:</p>

<ol>
<li>Create a callback function to be triggered automatically when the user closes the dialog. This function has to have a
single parameter to which the dialog will be passed with obtained results.</li>
<li>Invoke the constructor of a specific dialog to create a dialog instance, passing required parameters and callback.</li>
<li>Have a player object request the dialog in the user&#39;s client. Script execution does not stop after this request. The
callback with results is called whenever the user closes the dialog.</li>
</ol>

<p>Usually, creating an object would be described before talking about results. However, here we chose a different order to
follow the three steps mentioned above, which reflect the order in which you would write a dialog, and to review the
most interesting details first, namely what each dialog actually contributes to a particular script.</p>
<h3 id='messagedialog'>MessageDialog</h3>
<p>Use this dialog to display bulk text in an on-screen window. The user can close the window at any time.</p>
<div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span><span class="n">inform</span><span class="p">(</span><span class="s2">"Dialog closed"</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">lyrics</span> <span class="o">=</span> <span class="s">[[
O Fortuna
Velut luna
Statu variabilis
...
]]</span>

<span class="kd">local</span> <span class="n">dialog</span> <span class="o">=</span> <span class="n">MessageDialog</span><span class="p">(</span><span class="s2">"O Fortuna"</span><span class="p">,</span> <span class="n">lyrics</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
<span class="n">user</span><span class="p">:</span><span class="n">requestMessageDialog</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
</code></pre></div><h4 id='results'>Results</h4>
<p>This type of dialog by it&#39;s very nature has no results to be accessed. Still a callback makes sense, because you might
want to react to the dialog being closed.</p>
<h4 id='construction'>Construction</h4><h5 id='messagedialog-messagedialog-string-title-string-message-function-callback'><code>MessageDialog MessageDialog(string title, string message, function callback)</code></h5>
<p>Creates a MessageDialog with a specific <code>title</code> and <code>message</code>.</p>
<h4 id='request'>Request</h4><h5 id='user-requestmessagedialog-messagedialog-dialog'><code>user:requestMessageDialog(MessageDialog dialog)</code></h5><h3 id='inputdialog'>InputDialog</h3>
<p>This dialog requests text input from the user. If you want to further restrict the input, make that clear to the user
using the description and enforce it inside the callback. For different kinds of input (e.g. items) use or request
development of a different type of dialog.</p>
<div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dialog</span><span class="p">:</span><span class="n">getSuccess</span><span class="p">()</span> <span class="k">then</span>
        <span class="n">user</span><span class="p">:</span><span class="n">inform</span><span class="p">(</span><span class="s2">"You canceled! How dare you?"</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">user</span><span class="p">:</span><span class="n">inform</span><span class="p">(</span><span class="s2">"You wrote: "</span> <span class="o">..</span> <span class="n">dialog</span><span class="p">:</span><span class="n">getInput</span><span class="p">())</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">dialog</span> <span class="o">=</span> <span class="n">InputDialog</span><span class="p">(</span><span class="s2">"Insert some text!"</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
<span class="n">user</span><span class="p">:</span><span class="n">requestInputDialog</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
</code></pre></div><h4 id='results'>Results</h4><h5 id='boolean-getsuccess'><code>boolean getSuccess()</code></h5>
<p>The result is <code>true</code> if the dialog was confirmed and <code>false</code> if it was aborted.</p>
<h5 id='string-getinput'><code>string getInput()</code></h5>
<p>Returns the user&#39;s input if the dialog was successful. The return value is undefined if the dialog was aborted.</p>
<h4 id='construction'>Construction</h4><h5 id='inputdialog-inputdialog-string-title-string-description-boolean-multiline-number-maxchars-function-callback'><code>InputDialog InputDialog(string title, string description, boolean multiline, number maxChars, function callback)</code></h5>
<p>Creates an InputDialog with <code>title</code> and <code>description</code>. It allows line breaks iff <code>multiline</code> is set to <code>true</code>.
The input can be up to <code>maxChars</code> characters long.</p>
<h4 id='request'>Request</h4><h5 id='user-requestinputdialog-inputdialog-dialog'><code>user:requestInputDialog(InputDialog dialog)</code></h5><h2 id='itemlookat'>ItemLookAt</h2>
<p>Holds information about an item which is used by the client to display item inspection pop-ups. It is mainly used in the
<a href="#server">server entry point</a> <code>lookAtItem</code> and the <a href="#items">Item entry point</a> <code>LookAtItem</code>.</p>
<h3 id='variables'>Variables</h3><div class="highlight"><pre class="highlight lua tab-lua"><code><span class="kd">local</span> <span class="n">itemLookAt</span> <span class="o">=</span> <span class="n">ItemLookAt</span><span class="p">()</span>
<span class="n">itemLookAt</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Sword"</span>
<span class="n">itemLookAt</span><span class="p">.</span><span class="n">rareness</span> <span class="o">=</span> <span class="n">ItemLookAt</span><span class="p">.</span><span class="n">uncommonItem</span>
</code></pre></div>
<p>All variables are writable.</p>

<table><thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>name</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>item name, <em>must</em> be set</td>
</tr>
<tr>
<td>rareness</td>
<td>number</td>
<td><code>ItemLookAt.commonItem</code></td>
<td>has to be one of ItemLookAt.commonItem, ItemLookAt.uncommonItem, ItemLookAt.rareItem, ItemLookAt.epicItem</td>
</tr>
<tr>
<td>description</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>item description</td>
</tr>
<tr>
<td>craftedBy</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>who crafted the item</td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>states what kind of item this is</td>
</tr>
<tr>
<td>level</td>
<td>number</td>
<td><code>0</code></td>
<td>item level from 0 to 100</td>
</tr>
<tr>
<td>usable</td>
<td>boolean</td>
<td><code>true</code></td>
<td>can the item be used by players?</td>
</tr>
<tr>
<td>weight</td>
<td>number</td>
<td><code>0</code></td>
<td>item weight</td>
</tr>
<tr>
<td>worth</td>
<td>number</td>
<td><code>0</code></td>
<td>selling price (to NPCs) in copper coins</td>
</tr>
<tr>
<td>qualityText</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>describing item quality</td>
</tr>
<tr>
<td>durabilityText</td>
<td>string</td>
<td><code>&quot;&quot;</code></td>
<td>describing item durability</td>
</tr>
<tr>
<td>durabilityValue</td>
<td>number</td>
<td><code>0</code></td>
<td>from 0 to 100 in percent</td>
</tr>
<tr>
<td>diamondLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>emeraldLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>rubyLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>sapphireLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>amethystLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>obsidianLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>topazLevel</td>
<td>number</td>
<td><code>0</code></td>
<td>magic gem level from 0 to 10</td>
</tr>
<tr>
<td>bonus</td>
<td>number</td>
<td><code>0</code></td>
<td>gem bonus from 0 to 255</td>
</tr>
</tbody></table>
<h3 id='functions'>Functions</h3><h4 id='itemlookat-2'><code>ItemLookAt()</code></h4>
<p>Returns new ItemLookAt with default values.</p>
<h1 id='common-bugs'>Common Bugs</h1>
<ul>
<li>Missing <code>end</code>, missing <code>(</code> or <code>)</code></li>
<li>Script name and db entry do not match (be careful of invisible characters!).<br>
Try to query the db like this: <code>SELECT FROM illarionserver.items WHERE itm_script=&#39;item.doors&#39;)</code>.<br>
<code>.</code> is used to seperate directory/file names and the <code>.lua</code> extension is omitted.</li>
<li>Mixing up seperators <code>.</code> (fields) and <code>:</code> (member functions).</li>
<li>Missing <code>()</code> for functions without parameters.</li>
<li>Incorrect number of parameters for functions.</li>
<li>Mispelled function names (use syntax highlighting!).</li>
<li>Forgot !fr in game to reload tables and scripts.</li>
<li><code>=</code> instead of <code>==</code> or vice versa.</li>
<li><code>!=</code> instead of <code>~=</code> (not equal).</li>
<li>Missing conversion of a string to a number (<code>local ten = tonumber(&quot;10&quot;)</code>).</li>
<li>Beware of endless loops, they freeze the server. Always ensure that the script terminates.</li>
<li>Instructions after <code>return</code>.</li>
<li>Missing <code>then</code> in <code>if</code>-blocks, missing <code>end</code> in inline-<code>if</code>.</li>
</ul>
<h1 id='changelog'>Changelog</h1>
<table><thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Changes</th>
</tr>
</thead><tbody>
<tr>
<td>6.0</td>
<td>xx/xx/202x</td>
<td>Illarion Lua is now documented with Slate</td>
</tr>
<tr>
<td>5.24</td>
<td>12/09/2020</td>
<td><a href="https://github.com/Illarion-eV/Illarion-Server/blob/0.11.0/doc/luadoc.pdf">Last version in LaTex format</a></td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="lua">Lua</a>
          </div>
      </div>
    </div>
  </body>
</html>
